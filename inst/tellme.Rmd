---
title: "Tellme Benchmark Report for LPJ-GUESS"
author: "Matthew Forrest"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
output: 
  html_document:
    toc: true
params:
  new_directory:
    value: "/home/mforrest/GuessRuns/Tellus_dev/trunk10115crg+monthly"
  new_name:
    value: "New Run"
  old_directory:
    value: "/home/mforrest/GuessRuns/Tellus_dev/trunk10115crg+monthly"
  old_name:
    value: "Old Run"
  data_directory: 
    value: "/data/shared/Tellus"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(DGVMTools)
library(DGVMBenchmarks)
library(terra)
library(viridis)
```

## Settings

Below you can see the setting for this run of the benchmarking script.

```{r settings}

#### DEFINE LPJ-GUESS RUNS ####
# NOTE:
#  The paths defined in the "dir" argument only point to the overall benchmark directory.  
#  To actually access one of the benchmark runs (ie crop_global) you should copy these Source objects 
#  and manually append the benchmark directory name to the "dir".  See the GCP code block for an example.

# new
new_simulation_Source <- defineSource(name = params$new_name,
                                      dir = params$new_directory,
                                      format = GUESS)


# reference run
old_simulation_Source <- defineSource(name = params$old_name,
                                      dir = params$old_directory,
                                      format = GUESS)

# combine into a list for looping later
all_simulation_Sources_list <- list(old_simulation_Source, new_simulation_Source)

# quik read switch and version label (for making quick read files)
quick_read <- TRUE
version_label <- "tellus_v1.0" 

# switches for which benchmarks to do
do_GCP_NEE <- FALSE
do_GOSIF_GPP <- FALSE
do_MODIS_LAI <- TRUE


```

## Global Carbon Project Net Ecosystem Exchange

I think I remember Almut strongly preferring "Net Biome Productivity" terminology instead of NEE, or perhaps there is difference between the two I don't quite recall.  So if someone can explain with this to me at some point I would be happy...

Potential intro text about GCP, links to online description of the data, what to look for in the benchmark, blahblah

```{r gcp, echo=FALSE, out.width = '100%'}

if(do_GCP_NEE){
  
  ### Read the data and calculate the annual mean over the whole period
  GCP_full_Field <- read_GCP()
  GCP_full_Field_ymean  <- suppressWarnings(aggregateYears(GCP_full_Field, "mean"))
  
  
  # make a list of all Fields to be compared  (this will also include whatever model runs are available)
  all_NEE_Fields_list <- list("GCP" = GCP_full_Field)
  # and the vector of labels to eventual put on the plot
  all_NEE_labels_vector <- c(paste0("GCB residual: ", signif(GCP_full_Field_ymean@data[["NEE"]], 3)))
  
  
  
  ### Read the LPJ-GUESS data
  
  # for now hard code the first and last years
  first_GCP_GUESS_year <- 1959
  last_GCP_GUESS_year <- 2015
  
  # loop through model runs to be processed
  for(this_simulation_Source in all_simulation_Sources_list) {
    
    # check if file is present (if not don't include this run)
    this_benchmark_run_dir <- file.path(this_simulation_Source@dir, "crop_global")
    if(file.exists(file.path(this_benchmark_run_dir, "cflux.out")) || file.exists(file.path(this_benchmark_run_dir, "cflux.out.gz"))) {
      
      # make local sources pointing to the crop_global directory
      this_crop_global_Source <- this_simulation_Source
      this_crop_global_Source@dir <- this_benchmark_run_dir
      
      # read the data and process it into global sums
      this_simulation_NEE <- getField(source = this_crop_global_Source,
                                      "cflux",
                                      first.year = first_GCP_GUESS_year,
                                      last.year = last_GCP_GUESS_year,
                                      spatial.aggregate.method = "w.sum",
                                      spatial.extent.id = "Global",
                                      quick.read = quick_read,
                                      quick.read.file = paste("cflux", version_label, sep = "_") 
      )
      this_simulation_NEE <- layerOp(x = this_simulation_NEE, operator = "divc", layers = layers(this_simulation_NEE), new.layer = layers(this_simulation_NEE), constant = -1E12)
      
      # store the Field in the list of all Fields for plotting later
      all_NEE_Fields_list[[this_simulation_Source@id]] <- this_simulation_NEE
      
      # calculate yearly means of whole period
      # supressWarnings is just to stops warnings that there is no spatial or temporal data in the resulting Field
      # (all averaged away to give a single number)
      this_simulation_NEE_ymean <- suppressWarnings(aggregateYears(this_simulation_NEE, "mean"))
      
      # make a text label for putting the yearly mean on th plot and aa it to the label vector of labels
      all_NEE_labels_vector <- append(all_NEE_labels_vector, paste0(this_simulation_NEE_ymean@source@name, ": ", signif(this_simulation_NEE_ymean@data[["NEE"]])))
      
      
    }
    
  }
  
  
  # plot all together
  NEE_plot <- plotTemporal(all_NEE_Fields_list, 
                           col.by = "Source", 
                           layers = "NEE", 
                           title = "Global NEE", 
                           subtitle = NULL, 
                           y.label = "Global NEE (TgC/year)",
                           text.multiplier = 2, 
                           sizes = 1)
  
  # make a simple data.frame to put numbers on the plot, and then add it to the plot
  global.numbers.df <- data.frame(x= rep(as.Date(paste(first_GCP_GUESS_year), "%Y")), 
                                  y = c(6, 5, 4), 
                                  label = all_NEE_labels_vector)
  NEE_plot <-  NEE_plot + geom_text(data = global.numbers.df,  mapping = aes(x = x, y = y, label = label), size = 6, hjust = 0, col = "black")
  print(NEE_plot)
  
  # Also print all the data used to make the lines on the plot, this is just an example, obviously it can be adjusted
  NEE_table <- plotTemporal(all_NEE_Fields_list, 
                            col.by = "Source", 
                            layers = "NEE", 
                            plot = FALSE)
  
  print(NEE_table)
  
}

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
Also note that the table above it just an example with the default formatting.  I have not yet looked into making prettier tables, but it is definitely possible, see here: [https://rmarkdown.rstudio.com/lesson-7.html](https://rmarkdown.rstudio.com/lesson-7.html)

## GOSIF Gross Primary Productivity

Intro blah blah blah

```{r GOSIF GPP data prep, echo=FALSE, out.width = '100%'}

if(do_GOSIF_GPP){
  
  ### Here we read the model and data for both the spatial and trend analyses (which are actually done in the next code blocks)
  
  ### some parameters and settings
  LPJ_GUESS_variable <- "mgpp"
  first_year_GOSIF <- 2001
  last_year_GOSIF <- 2018
  
  ### for the full monthly data (stored externally to the package)
  GOSIF_GPP_monthly_dir <- "monthly_gpp/GOSIFGPP"
  GOSIF_GPP_monthly_file.name <- "GOSIF_GPP.txt"
  
  # file names for the files in the package
  GOSIF_trend_file_name <- "GOSIFGPP_slope_2001-2018.txt"
  GOSIF_sig_file_name <- "GOSIFGPP_sig_2001-2018.txt"
  
  ### Lists for storing the files
  all_GPP_Map_Fields_list <- list()
  all_GPP_Trend_Fields_list <- list()
  all_GPP_Seasonal_Fields_list <- list()
  
  
  #### READ GOSIF DATA ####
  
  ### read the GOSIF full monthly data
  full_file_path <- file.path(params$data_directory, GOSIF_GPP_monthly_dir, GOSIF_GPP_monthly_file.name)
  if(file.exists(full_file_path)) {
    
    # Read the GOSIF monthly data via a GUESS formatted Source
    GOSIF_Source <- defineSource(id = "GOSIF_GPP",
                                 name = "GOSIF GPP",
                                 dir = file.path(params$data_directory, GOSIF_GPP_monthly_dir),
                                 format = GUESS)
    GOSIF_full_Field <- getField(source = GOSIF_Source,
                                 var = LPJ_GUESS_variable,
                                 file.name = GOSIF_GPP_monthly_file.name)
    
    # delete values with -9999 and covert to kg
    GOSIF_full_Field@data <- GOSIF_full_Field@data[mgpp != -9999.0,]
    GOSIF_full_Field <- layerOp(GOSIF_full_Field, operator = "divc", constant = 1000, layers = "mgpp", new.layer = "mgpp")
    
    # make the annual map for comparison (leave only spatial)
    all_GPP_Map_Fields_list[["GOSIF"]] <- aggregateYears(aggregateSubannual(GOSIF_full_Field, method = "sum", target = "Year"), method = "mean")
    
    # make the seasonal cycle for comparison (leave months and  spatial)
    all_GPP_Seasonal_Fields_list[["GOSIF"]] <- aggregateYears(GOSIF_full_Field, method = "mean")
    
  }
  
  ### Read the GOSIF data 
  input_dir <- system.file("extdata", "GOSIF_GPP", package = "DGVMBenchmarks")
  
  # read into a terra::SpatRaster
  GOSIF_trend_matrix <- as.matrix(read.table(file.path(input_dir, GOSIF_trend_file_name), sep="\t"))
  GOSIF_sig_matrix <- as.matrix(read.table(file.path(input_dir, GOSIF_sig_file_name), sep="\t"))
  
  GOSIF_trend_SpatRaster <- rast(GOSIF_trend_matrix)
  GOSIF_sig_SpatRaster <- rast(GOSIF_sig_matrix)
  
  ext(GOSIF_trend_SpatRaster) <- ext(-180, 180, -90,90)
  ext(GOSIF_sig_SpatRaster) <- ext(-180, 180, -90,90)
  
  GOSIF_trend_SpatRaster[GOSIF_trend_SpatRaster == -9999] <- NA
  GOSIF_sig_SpatRaster[GOSIF_sig_SpatRaster == -9999] <- NA
  
  # melt into data.tables, combine and set names
  GOSIF_trend_dt<- as.data.table(as.data.frame(GOSIF_trend_SpatRaster, xy = TRUE, cells = FALSE))
  GOSIF_sig_dt<- as.data.table(as.data.frame(GOSIF_sig_SpatRaster, xy = TRUE, cells = FALSE))
  GOSIF_dt <- merge.data.table(GOSIF_trend_dt, GOSIF_sig_dt, by =  c("x", "y"))
  setnames(GOSIF_dt, c("Lon", "Lat", "Slope", "p.value"))
  
  #  manually construct a Field object
  GOSIF_Trend_Source <- defineSource(id = "GOSIF_GPP",
                                     name = "GOSIF GPP",
                                     dir = input_dir,
                                     format = GUESS)
  
  GOSIF_Trend_Field <- new("Field",
                           data = GOSIF_dt,
                           source = GOSIF_Trend_Source,
                           quant = lookupQuantity(LPJ_GUESS_variable, GUESS),
                           first.year = first_year_GOSIF,
                           last.year = last_year_GOSIF,
                           year.aggregate.method = "linear_trend",
                           spatial.extent = extent(GOSIF_dt),
                           spatial.extent.id = "Full",
                           spatial.aggregate.method = "none",
                           subannual.resolution = "Year",
                           subannual.original = "8-day",
                           subannual.aggregate.method = "sum")
  
  GOSIF_Trend_Field@id <- makeFieldID(GOSIF_Trend_Field)
  
  # make a list of all Fields to be compared  (this will also include whatever model runs are available)
  all_GPP_Trend_Fields_list[["GOSIF"]] <- GOSIF_Trend_Field
  
  
  
  #### READ LPJ-GUESS GPP DATA ####
  # Comparisons
  model_data_comparisons_list <- list()
  
  # loop through model runs to be processed
  for(this_simulation_Source in all_simulation_Sources_list) {
    
    # check if file is present (if not don't include this run)
    this_benchmark_run_dir <- file.path(this_simulation_Source@dir, "crop_global")
    if(file.exists(file.path(this_benchmark_run_dir, paste0(LPJ_GUESS_variable, ".out"))) || file.exists(file.path(this_benchmark_run_dir,  paste0(LPJ_GUESS_variable, ".out.gz")))) {
      
      # make local sources pointing to the crop_global directory
      this_crop_global_Source <- this_simulation_Source
      this_crop_global_Source@dir <- this_benchmark_run_dir
      
      # read the full data and
      suppressWarnings(
        this_simulation_GPP <- getField(source = this_crop_global_Source,
                                        LPJ_GUESS_variable,
                                        first.year = first_year_GOSIF,
                                        last.year = last_year_GOSIF,
                                        quick.read = quick_read,
                                        quick.read.file = paste(LPJ_GUESS_variable, version_label, sep = "_"))
      )
      
      ### take sum of month and average of years and store for later use - very easy ###
      all_GPP_Map_Fields_list[[this_simulation_Source@id]] <- aggregateYears(aggregateSubannual(this_simulation_GPP, target = "Year", method = "sum"),  "mean")
      
      ### take yearly average and store for later use - very easy ###
      all_GPP_Seasonal_Fields_list[[this_simulation_Source@id]] <- aggregateYears(this_simulation_GPP, "mean")
      
      
      ### calculate the linear trend and p-value for every gridcell and store for later use ###     
      this_simulation_GPP_dt <- this_simulation_GPP@data
      
      # suppress warnings about "essentially perfect fit"
      #suppressWarnings(fitted_trends_dt <- this_simulation_GPP_dt[, as.list(summary(lm(mgpp~Year))$coefficients[2,c(1,4)]), by = .(Lon, Lat)])
      fitted_trends_dt <- this_simulation_GPP_dt[, as.list(summary(lm(mgpp~Year))$coefficients[2,c(1,4)]), by = .(Lon, Lat)]
      setnames(fitted_trends_dt, c("Estimate", "Pr(>|t|)"), c("Slope", "p.value"))
      this_simulation_GPP@data <- fitted_trends_dt
      this_simulation_GPP@year.aggregate.method <- "linear_trend"
      this_simulation_GPP@id <- makeFieldID(this_simulation_GPP)
      
      # change units to gC/m^-2/month^-2
      this_simulation_GPP <- layerOp( this_simulation_GPP, operator = "mulc", constant = 1000/144, layers = "Slope", new.layer = "Slope")
      
      # store the Field in the list of all Fields for plotting later
      all_GPP_Trend_Fields_list[[this_simulation_Source@id]] <- this_simulation_GPP
      
      # remove to save memory
      rm(this_simulation_GPP)
      
    } # if file is present 
    
  } # for each model run
  
} # if do_GOSIF_GPP


```



### Spatial analysis

Here plot maps


```{r GOSIF GPP map, echo=FALSE, out.width = '100%'}

if(do_GOSIF_GPP){
  
  # Do spatial comparisons for each model run
  # Comparisons
  spatial_comparisons_list <- list()
  
  # loop through model runs to be processed
  for(this_simulation_Source in all_simulation_Sources_list) {
    
    # make comparison 
    message(paste("Comparison stats for run", this_simulation_Source@name, "GPP values vs. GOSIF GPP values"))
    suppressWarnings(
      suppressMessages(
        spatial_comparisons_list[[this_simulation_Source@id]] <- compareLayers(field1 = all_GPP_Map_Fields_list[[this_simulation_Source@id]],
                                                                               field2 = all_GPP_Map_Fields_list[["GOSIF"]],
                                                                               layers1 =  LPJ_GUESS_variable,
                                                                               layers2 =  LPJ_GUESS_variable)
      )
    )
  }
  
  
  # plot all slope values together
  GPP_abs_values_plot <- plotSpatial(all_GPP_Map_Fields_list, 
                                     ncol = 1, 
                                     legend.title = expression(kgC~m^{"-2"}~year^{"-1"}) )
  # suppress warnings about uneven horizontal intervals
  suppressWarnings(print(GPP_abs_values_plot))
  
  # also make the difference plots
  GPP_diff_values_plot <- plotSpatialComparison(spatial_comparisons_list, 
                                                ncol = 1, 
                                                legend.title = expression(Delta~kgC~m^{"-2"}~year^{"-1"}) )
  # suppress warnings about uneven horizontal intervals
  suppressWarnings(print(GPP_diff_values_plot))
  
  
}

```


### Trend analysis

Here plot trends

```{r GOSIF GPP trend, echo=FALSE, out.width = '100%'}

if(do_GOSIF_GPP) {
  
  ### Read the LPJ-GUESS data
  
  # Comparisons
  trend_comparisons_list <- list()
  
  # loop through model runs to be processed
  for(this_simulation_Source in all_simulation_Sources_list) {
    
    # make comparison 
    message(paste("Comparison stats for run", this_simulation_Source@name, "GPP trend vs. GOSIF GPP trend"))
    suppressWarnings(
      suppressMessages(
        trend_comparisons_list[[this_simulation_Source@id]] <- compareLayers(field1 = all_GPP_Trend_Fields_list[[this_simulation_Source@id]],
                                                                             field2 = all_GPP_Trend_Fields_list[["GOSIF"]],
                                                                             layers1 = "Slope",
                                                                             layers2 = "Slope")
      )
    )
    
  }
  
  
  # plot all slope values together
  GPP_trend_plot <- plotSpatial(all_GPP_Trend_Fields_list, 
                                layers = "Slope", 
                                ncol = 1, 
                                cols = rev(RColorBrewer::brewer.pal(11, "RdBu")), 
                                #cuts = c(-1.0, -0.5, -0.2, -0.1, -0.05, -0.02, -0.01, 0, 0.01, 0.02, 0.05, 0.1, 0.2, 0.5, 1.0),
                                limits = c(-0.5,0.5),
                                drop.cuts = FALSE,
                                title = "Trend in GPP", 
                                legend.title = expression(gC~m^{"-2"}~month^{"-2"}))
  # suppress warnings about uneven horizontal intervals
  suppressWarnings(print(GPP_trend_plot))
  
  # plot differences in model vs data slope values together
  GPP_trend_diff_plot <-  suppressWarnings(
    plotSpatialComparison(trend_comparisons_list, 
                          ncol = 1, 
                          #cuts = c(-1.0, -0.5, -0.2, -0.1, -0.05, -0.02, -0.01, 0, 0.01, 0.02, 0.05, 0.1, 0.2, 0.5, 1.0),
                          drop.cuts = FALSE,
                          title = "Difference Trend in GPP", 
                          legend.title =  expression(Delta~gC~m^{"-2"}~month^{"-2"}))
  )
  # suppress warnings about uneven horizontal intervals
  suppressWarnings(print(GPP_trend_diff_plot))
  
  # and plot significance
  GPP_trend_sig_plot <- plotSpatial(all_GPP_Trend_Fields_list, 
                                    layers = "p.value", 
                                    ncol = 1, 
                                    #cols = rev(RColorBrewer::brewer.pal(11, "RdBu")), 
                                    cuts = c(0, 0.001, 0.01, 0.05, 0.1, 0.5, 1.0),
                                    drop.cuts = FALSE,
                                    title = "Significance in GPP Trends",
                                    legend.title =  "p value")
  # suppress warnings about uneven horizontal intervals
  suppressWarnings(print(GPP_trend_sig_plot))
  
  
  
  
}

```


### Seasonal analysis


```{r GOSIF GPP seasonality, echo=FALSE, out.width = '100%'}

if(do_GOSIF_GPP) {
  
  ### Read the LPJ-GUESS data
  
  # Comparisons
  seasonal_comparisons_list <- list()
  
  # before doing comparision, set all (incorrectly) negative GPPs to zero
  min2zero <- function(x){
    pmax(x,0)
  }
  this_simulation_only_positive <- layerOp(all_GPP_Seasonal_Fields_list[[this_simulation_Source@id]],
                                           operator = min2zero,
                                           layers = "mgpp", 
                                           new.layer = "mgpp")

  
  # loop through model runs to be processed
  for(this_simulation_Source in all_simulation_Sources_list) {
    
    # make comparison 
    message(paste("Comparison stats for run", this_simulation_Source@name, "GPP seasonality vs. GOSIF seasonality trend"))
    suppressWarnings(
      suppressMessages(
        
        
        
        
        seasonal_comparisons_list[[this_simulation_Source@id]] <- compareLayers(field1 = this_simulation_only_positive,
                                                                                field2 = all_GPP_Seasonal_Fields_list[["GOSIF"]],
                                                                                layers1 = LPJ_GUESS_variable,
                                                                                layers2 = LPJ_GUESS_variable, 
                                                                                do.seasonality = TRUE)
      )
    )
    
  }
  
  
  #### PHASE
  # absolute value
  GPP_seasonality_vals_plot <- plotSpatialComparison(seasonal_comparisons_list, 
                                                     do.phase = TRUE,
                                                     type = "values",
                                                     cuts = 0:12,
                                                     ncol = 1)
  suppressWarnings(print(GPP_seasonality_vals_plot))
  
  # difference
  GPP_seasonality_diff_plot <- plotSpatialComparison(seasonal_comparisons_list, 
                                                     do.phase = TRUE,
                                                     cuts = seq(-6,6), 
                                                     symmetric.scale = FALSE,
                                                     ncol = 1)
  suppressWarnings(print(GPP_seasonality_diff_plot))
  
  #### CONCENTRATION
  # absolute value
  GPP_seasonality_conc_vals_plot <- plotSpatialComparison(seasonal_comparisons_list, 
                                                          type = "values",
                                                          ncol = 1)
  suppressWarnings(print(GPP_seasonality_conc_vals_plot))
  
  # difference value
  GPP_seasonality_conc_diff_plot <- plotSpatialComparison(seasonal_comparisons_list, 
                                                          ncol = 1)
  suppressWarnings(print(GPP_seasonality_conc_diff_plot))
  
}

```

## MODIS Leaf Area Index



```{r MODIS LAI data prep, echo=FALSE, out.width = '100%'}

if(do_MODIS_LAI){
  
  ### Here we read the model and data for both the spatial and trend analyses (which are actually done in the next code blocks)
  
  ### some parameters and settings
  LPJ_GUESS_variable <- "mlai"
  first_year_MODIS <- 2001
  last_year_MODIS <- 2020
  
  ### for the full monthly data (stored externally to the package)
  MODIS_LAI_monthly_dir <- "monthly_lai/MODIS"
  MODIS_LAI_monthly_file.name <- "MODIS_LAI.txt"
  
  # file names for the files in the package
  MODIS_trend_file_name <- "MODIS_LAI_slope_2001-2020.txt"
  MODIS_sig_file_name <- "MODIS_LAI_sig_2001-2020.txt"
  
  ### Lists for storing the files
  all_LAI_Map_Fields_list <- list()
  all_LAI_Trend_Fields_list <- list()
  all_LAI_Seasonal_Fields_list <- list()
  
  
  #### READ MODIS DATA ####
  
  ### read the MODIS full monthly data
  full_file_path <- file.path(params$data_directory, MODIS_LAI_monthly_dir, MODIS_LAI_monthly_file.name)
  if(file.exists(full_file_path)) {

    # Read the MODIS monthly data via a GUESS formatted Source
    MODIS_Source <- defineSource(id = "MODIS_LAI",
                                 name = "MODIS LAI",
                                 dir = file.path(params$data_directory, MODIS_LAI_monthly_dir),
                                 format = GUESS)
    MODIS_full_Field <- getField(source = MODIS_Source,
                                 var = LPJ_GUESS_variable,
                                 file.name = MODIS_LAI_monthly_file.name)
    
    # delete values with -9999
    MODIS_full_Field@data <- MODIS_full_Field@data[mlai != -9999.0,]

    # make the annual map for comparison (leave only spatial)
    all_LAI_Map_Fields_list[["MODIS"]] <- aggregateYears(aggregateSubannual(MODIS_full_Field, method = "max", target = "Year"), method = "mean")
    
    # make the seasonal cycle for comparison (leave months and  spatial)
    all_LAI_Seasonal_Fields_list[["MODIS"]] <- aggregateYears(MODIS_full_Field, method = "mean")
    
  }
  
  ### Read the MODIS data 
  input_dir <- system.file("extdata", "MODIS_LAI", package = "DGVMBenchmarks")
  
  # read into a terra::SpatRaster
  MODIS_trend_matrix <- as.matrix(read.table(file.path(input_dir, MODIS_trend_file_name), sep="\t"))
  MODIS_sig_matrix <- as.matrix(read.table(file.path(input_dir, MODIS_sig_file_name), sep="\t"))
  
  MODIS_trend_SpatRaster <- rast(MODIS_trend_matrix)
  MODIS_sig_SpatRaster <- rast(MODIS_sig_matrix)
  
  ext(MODIS_trend_SpatRaster) <- ext(-180, 180, -90,90)
  ext(MODIS_sig_SpatRaster) <- ext(-180, 180, -90,90)
  
  MODIS_trend_SpatRaster[MODIS_trend_SpatRaster == -9999] <- NA
  MODIS_sig_SpatRaster[MODIS_sig_SpatRaster == -9999] <- NA
  
  # melt into data.tables, combine and set names
  MODIS_trend_dt<- as.data.table(as.data.frame(MODIS_trend_SpatRaster, xy = TRUE, cells = FALSE))
  MODIS_sig_dt<- as.data.table(as.data.frame(MODIS_sig_SpatRaster, xy = TRUE, cells = FALSE))
  MODIS_dt <- merge.data.table(MODIS_trend_dt, MODIS_sig_dt, by =  c("x", "y"))
  setnames(MODIS_dt, c("Lon", "Lat", "Slope", "p.value"))
  
  #  manually construct a Field object
  MODIS_Trend_Source <- defineSource(id = "MODIS_LAI",
                                     name = "MODIS LAI",
                                     dir = input_dir,
                                     format = GUESS)
  
  MODIS_Trend_Field <- new("Field",
                           data = MODIS_dt,
                           source = MODIS_Trend_Source,
                           quant = lookupQuantity(LPJ_GUESS_variable, GUESS),
                           first.year = first_year_MODIS,
                           last.year = last_year_MODIS,
                           year.aggregate.method = "linear_trend",
                           spatial.extent = extent(MODIS_dt),
                           spatial.extent.id = "Full",
                           spatial.aggregate.method = "none",
                           subannual.resolution = "Year",
                           subannual.original = "8-day",
                           subannual.aggregate.method = "sum")
  
  MODIS_Trend_Field@id <- makeFieldID(MODIS_Trend_Field)
  
  # make a list of all Fields to be compared  (this will also include whatever model runs are available)
  all_LAI_Trend_Fields_list[["MODIS"]] <- MODIS_Trend_Field
  
  
  
  #### READ LPJ-GUESS LAI DATA ####
  # Comparisons
  model_data_comparisons_list <- list()
  
  # loop through model runs to be processed
  for(this_simulation_Source in all_simulation_Sources_list) {
    
    # check if file is present (if not don't include this run)
    this_benchmark_run_dir <- file.path(this_simulation_Source@dir, "crop_global")
    if(file.exists(file.path(this_benchmark_run_dir, paste0(LPJ_GUESS_variable, ".out"))) || file.exists(file.path(this_benchmark_run_dir,  paste0(LPJ_GUESS_variable, ".out.gz")))) {
      
      # make local sources pointing to the crop_global directory
      this_crop_global_Source <- this_simulation_Source
      this_crop_global_Source@dir <- this_benchmark_run_dir
      
      # read the full data and
      suppressWarnings(
        this_simulation_LAI <- getField(source = this_crop_global_Source,
                                        LPJ_GUESS_variable,
                                        first.year = first_year_MODIS,
                                        quick.read = quick_read,
                                        quick.read.file = paste(LPJ_GUESS_variable, version_label, sep = "_"))
      )
      
      ### take sum of month and average of years and store for later use - very easy ###
      all_LAI_Map_Fields_list[[this_simulation_Source@id]] <- aggregateYears(aggregateSubannual(this_simulation_LAI, target = "Year", method = "max"),  "mean")
      
      ### take yearly average and store for later use - very easy ###
      all_LAI_Seasonal_Fields_list[[this_simulation_Source@id]] <- aggregateYears(this_simulation_LAI, "mean")
      
      
      ### calculate the linear trend and p-value for every gridcell and store for later use ###     
      this_simulation_LAI_dt <- this_simulation_LAI@data
      
      # suppress warnings about "essentially perfect fit"
      #suppressWarnings(fitted_trends_dt <- this_simulation_LAI_dt[, as.list(summary(lm(mLAI~Year))$coefficients[2,c(1,4)]), by = .(Lon, Lat)])
      fitted_trends_dt <- this_simulation_LAI_dt[, as.list(summary(lm(mlai~Year))$coefficients[2,c(1,4)]), by = .(Lon, Lat)]
      setnames(fitted_trends_dt, c("Estimate", "Pr(>|t|)"), c("Slope", "p.value"))
      this_simulation_LAI@data <- fitted_trends_dt
      this_simulation_LAI@year.aggregate.method <- "linear_trend"
      this_simulation_LAI@id <- makeFieldID(this_simulation_LAI)
      
      # change units to gC/m^-2/month^-2
      this_simulation_LAI <- layerOp( this_simulation_LAI, operator = "mulc", constant = 1000/144, layers = "Slope", new.layer = "Slope")
      
      # store the Field in the list of all Fields for plotting later
      all_LAI_Trend_Fields_list[[this_simulation_Source@id]] <- this_simulation_LAI
      
      # remove to save memory
      rm(this_simulation_LAI)
      
    } # if file is present 
    
  } # for each model run
  
} # if do_MODIS_LAI


```


### Spatial analysis

Maps show max LAI of the year (averaged across all years).


```{r MODIS LAI map, echo=FALSE, out.width = '100%'}

if(do_MODIS_LAI){
  
  # Do spatial comparisons for each model run
  # Comparisons
  spatial_comparisons_list <- list()
  
  # loop through model runs to be processed
  for(this_simulation_Source in all_simulation_Sources_list) {
    
    # make comparison 
    message(paste("Comparison stats for run", this_simulation_Source@name, "LAI values vs. MODIS LAI values"))
    suppressWarnings(
      suppressMessages(
        spatial_comparisons_list[[this_simulation_Source@id]] <- compareLayers(field1 = all_LAI_Map_Fields_list[[this_simulation_Source@id]],
                                                                               field2 = all_LAI_Map_Fields_list[["MODIS"]],
                                                                               layers1 =  LPJ_GUESS_variable,
                                                                               layers2 =  LPJ_GUESS_variable)
      )
    )
  }
  
  
  # plot all slope values together
  LAI_abs_values_plot <- plotSpatial(all_LAI_Map_Fields_list, 
                                     ncol = 1, 
                                     legend.title = expression(kgC~m^{"-2"}~year^{"-1"}) )
  # suppress warnings about uneven horizontal intervals
  suppressWarnings(print(LAI_abs_values_plot))
  
  # also make the difference plots
  LAI_diff_values_plot <- plotSpatialComparison(spatial_comparisons_list, 
                                                ncol = 1, 
                                                legend.title = expression(Delta~kgC~m^{"-2"}~year^{"-1"}) )
  # suppress warnings about uneven horizontal intervals
  suppressWarnings(print(LAI_diff_values_plot))
  
  
}

```



### Trend analysis

Here plot trends

```{r MODIS LAI trend, echo=FALSE, out.width = '100%'}

if(do_MODIS_LAI) {
  
  ### Read the LPJ-GUESS data
  
  # Comparisons
  trend_comparisons_list <- list()
  
  # loop through model runs to be processed
  for(this_simulation_Source in all_simulation_Sources_list) {
    
    # make comparison 
    message(paste("Comparison stats for run", this_simulation_Source@name, "LAI trend vs. MODIS LAI trend"))
    suppressWarnings(
      suppressMessages(
        trend_comparisons_list[[this_simulation_Source@id]] <- compareLayers(field1 = all_LAI_Trend_Fields_list[[this_simulation_Source@id]],
                                                                             field2 = all_LAI_Trend_Fields_list[["MODIS"]],
                                                                             layers1 = "Slope",
                                                                             layers2 = "Slope")
      )
    )
    
  }
  
  
  # plot all slope values together
  LAI_trend_plot <- plotSpatial(all_LAI_Trend_Fields_list, 
                                layers = "Slope", 
                                ncol = 1, 
                                cols = rev(RColorBrewer::brewer.pal(11, "RdBu")), 
                                #cuts = c(-1.0, -0.5, -0.2, -0.1, -0.05, -0.02, -0.01, 0, 0.01, 0.02, 0.05, 0.1, 0.2, 0.5, 1.0),
                                limits = c(-0.5,0.5),
                                drop.cuts = FALSE,
                                title = "Trend in LAI"
                                )
  # suppress warnings about uneven horizontal intervals
  suppressWarnings(print(LAI_trend_plot))
  
  # plot differences in model vs data slope values together
  LAI_trend_diff_plot <-  suppressWarnings(
    plotSpatialComparison(trend_comparisons_list, 
                          ncol = 1, 
                          #cuts = c(-1.0, -0.5, -0.2, -0.1, -0.05, -0.02, -0.01, 0, 0.01, 0.02, 0.05, 0.1, 0.2, 0.5, 1.0),
                          drop.cuts = FALSE,
                          title = "Difference Trend in LAI")
  )
  # suppress warnings about uneven horizontal intervals
  suppressWarnings(print(LAI_trend_diff_plot))
  
  # and plot significance
  LAI_trend_sig_plot <- plotSpatial(all_LAI_Trend_Fields_list, 
                                    layers = "p.value", 
                                    ncol = 1, 
                                    #cols = rev(RColorBrewer::brewer.pal(11, "RdBu")), 
                                    cuts = c(0, 0.001, 0.01, 0.05, 0.1, 0.5, 1.0),
                                    drop.cuts = FALSE,
                                    title = "Significance in LAI Trends",
                                    legend.title =  "p value")
  # suppress warnings about uneven horizontal intervals
  suppressWarnings(print(LAI_trend_sig_plot))
  
  
  
  
}

```



### Seasonal analysis

```{r MODIS LAI seasonality, echo=FALSE, out.width = '100%'}

if(do_MODIS_LAI) {
  
  ### Read the LPJ-GUESS data
  
  # Comparisons
  seasonal_comparisons_list <- list()
  
  # loop through model runs to be processed
  for(this_simulation_Source in all_simulation_Sources_list) {
    
    # make comparison 
    message(paste("Comparison stats for run", this_simulation_Source@name, "LAI seasonality vs. MODIS seasonality trend"))
    suppressWarnings(
      suppressMessages(
        
        
        
        
        seasonal_comparisons_list[[this_simulation_Source@id]] <- compareLayers(field1 = all_LAI_Seasonal_Fields_list[[this_simulation_Source@id]],
                                                                                field2 = all_LAI_Seasonal_Fields_list[["MODIS"]],
                                                                                layers1 = LPJ_GUESS_variable,
                                                                                layers2 = LPJ_GUESS_variable, 
                                                                                do.seasonality = TRUE)
      )
    )
    
  }
  
  
  #### PHASE
  # absolute value
  LAI_seasonality_vals_plot <- plotSpatialComparison(seasonal_comparisons_list, 
                                                     do.phase = TRUE,
                                                     type = "values",
                                                     cuts = 0:12,
                                                     ncol = 1)
  suppressWarnings(print(LAI_seasonality_vals_plot))
  
  # difference
  LAI_seasonality_diff_plot <- plotSpatialComparison(seasonal_comparisons_list, 
                                                     do.phase = TRUE,
                                                     cuts = seq(-6,6), 
                                                     symmetric.scale = FALSE,
                                                     ncol = 1)
  suppressWarnings(print(LAI_seasonality_diff_plot))
  
  #### CONCENTRATION
  # absolute value
  LAI_seasonality_conc_vals_plot <- plotSpatialComparison(seasonal_comparisons_list, 
                                                          type = "values",
                                                          ncol = 1)
  suppressWarnings(print(LAI_seasonality_conc_vals_plot))
  
  # difference value
  LAI_seasonality_conc_diff_plot <- plotSpatialComparison(seasonal_comparisons_list, 
                                                          ncol = 1)
  suppressWarnings(print(LAI_seasonality_conc_diff_plot))
  
}

```