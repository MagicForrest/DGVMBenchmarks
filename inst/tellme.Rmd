---
title: "Tellme Benchmark for LPJ-GUESS"
author: "Matthew Forrest"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(DGVMTools)
library(DGVMBenchmarks)
```

## Settings

Below you can see the setting for this run of the benchmarking script.

```{r settings}

#### DEFINE LPJ-GUESS RUNS ####
# NOTES
#       1. The paths should obviously be defined as arguments to the script, also perhaps a more useful "run identifier" string.
#       2. The paths defined in the "dir" argument only point to the overall benchmark directory.  To actually access one of the benchmark runs (ie crop_global) you should copy these Source objects and manually append the benchmark directory name to the "dir".  See the GCP code block for an example.

# new
new_simulation_Source <- defineSource(id = "newrun",
                                      name = "New Run",
                                      format = GUESS,
                                      dir = "/home/mforrest/GuessRuns/Tellus_dev/outputRelease4.1_r10118full/")


# reference run
old_simulation_Source <- defineSource(id = "oldrun",
                                      name = "Old Run",
                                      format = GUESS,
                                      dir = "/home/mforrest/GuessRuns/Tellus_dev/output9957full/")

# combine into a list for looping later
all_simulation_Sources_list <- list(old_simulation_Source, new_simulation_Source)

# switches for which benchmarks to do
doGCP <- TRUE

```

## Global Carbon Project

Potential intro text about GCP, links to online description of the data, what to look for in the benchmark, blahblah

```{r gcp, echo=FALSE}

### Read the data and calculate the annual mean over the whole period
GCP_full_Field <- read_GCP()
GCP_full_Field_ymean  <- suppressWarnings(aggregateYears(GCP_full_Field, "mean"))


# make a list of all Fields to be compared  (this will also include whatever model runs are available)
all_NEE_Fields_list <- list("GCP" = GCP_full_Field)
# and the vector of labels to eventual put on the plot
all_NEE_labels_vector <- c(paste0("GCB residual: ", signif(GCP_full_Field_ymean@data[["NEE"]], 3)))



### Read the LPJ-GUESS data

# for now hard code the first and last years
first_GCP_GUESS_year <- 1959
last_GCP_GUESS_year <- 2015

# loop through model runs to be processed
for(this_simulation_Source in all_simulation_Sources_list) {
  
  # check if file is present (if not don't include this run)
  this_benchmark_run_dir <- file.path(this_simulation_Source@dir, "crop_global")
  if(file.exists(file.path(this_benchmark_run_dir, "cflux.out")) || file.exists(file.path(this_benchmark_run_dir, "cflux.out.gz"))) {
    
    # make local sources pointing to the crop_global directory
    this_crop_global_Source <- copy(this_simulation_Source)
    this_crop_global_Source@dir <- this_benchmark_run_dir
    
    # read the data and process it into global sums
    this_simulation_NEE <- getField(source = this_crop_global_Source,
                                    "cflux",
                                    first.year = first_GCP_GUESS_year,
                                    last.year = last_GCP_GUESS_year,
                                    spatial.aggregate.method = "w.sum",
                                    spatial.extent.id = "Global")
    this_simulation_NEE <- layerOp(x = this_simulation_NEE, operator = "divc", layers = layers(this_simulation_NEE), new.layer = layers(this_simulation_NEE), constant = -1E12)
    
    # store the Field in the list of all Fields for plotting later
    all_NEE_Fields_list[[this_simulation_Source@id]] <- this_simulation_NEE
    
    # calculate yearly means of whole period
    # supressWarnings is just to stops warnings that there is no spatial or temporal data in the resulting Field
    # (all averaged away to give a single number)
    this_simulation_NEE_ymean <- suppressWarnings(aggregateYears(this_simulation_NEE, "mean"))
    
    # make a text label for putting the yearly mean on th plot and aa it to the label vector of labels
    all_NEE_labels_vector <- append(all_NEE_labels_vector, paste0(this_simulation_NEE_ymean@source@name, ": ", signif(this_simulation_NEE_ymean@data[["NEE"]])))
    
    
  }
  
}


# plot all together
NEE_plot <- plotTemporal(all_NEE_Fields_list, 
                         col.by = "Source", 
                         layers = "NEE", 
                         title = "Global NEE", 
                         subtitle = NULL, 
                         y.label = "Global NEE (TgC/year)",
                         text.multiplier = 2, 
                         sizes = 1)

# make a simple data.frame to put numbers on the plot, and then add it to the plot
global.numbers.df <- data.frame(x= rep(as.Date(paste(first_GCP_GUESS_year), "%Y")), 
                                y = c(6, 5, 4), 
                                label = all_NEE_labels_vector)
NEE_plot <-  NEE_plot + geom_text(data = global.numbers.df,  mapping = aes(x = x, y = y, label = label), size = 6, hjust = 0, col = "black")
print(NEE_plot)

# Also print all the data used to make the lines on the plot, this is just an example, obviously it can be adjusted
NEE_table <- plotTemporal(all_NEE_Fields_list, 
                          col.by = "Source", 
                          layers = "NEE", 
                          plot = FALSE)

print(NEE_table)

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
Also note that the table above it just an example with the default formatting.  I have not yet looked into making prettier tables, but it is definitely possible, see here: [https://rmarkdown.rstudio.com/lesson-7.html](https://rmarkdown.rstudio.com/lesson-7.html)


